<template>
    <section>
        <ContentWrapper>
            <div>
                <h1 class="text-display-xl font-bold">Statistiques</h1>
                <div>
                    Depuis l'ouverture nationale de la plateforme en juin 2019
                </div>
            </div>

            <h2 class="text-display-lg font-bold text-secondary mt-16">
                Répartition des utilisateurs
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 mt-4">
                <div>
                    <PieChart
                        class="mb-16 md:mb-0 md:mr-16"
                        :height="250"
                        :chartData="organizationRepartitionData"
                        :chartOptions="{
                            plugins: {
                                legend: {
                                    position: 'right',
                                    align: 'start',
                                    labels: {
                                        generateLabels,
                                    },
                                },
                            },
                            maintainAspectRatio: false,
                        }"
                        v-if="numberOfPublicEstablishmentUsers !== '...'"
                    />
                    <span class="text-display-lg font-bold" v-else>...</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-16">
                    <StatsBlock
                        :title="numberOfDepartements"
                        icon="flag"
                        subtitle="départements"
                    />
                    <StatsBlock
                        :title="numberOfNewUsers.total"
                        icon="user-plus"
                        :subtitle="
                            'nouveaux utilisateurs en ' +
                            numberOfNewUsers.month.toLowerCase()
                        "
                    />
                </div>
            </div>

            <div>
                <h2 class="text-display-lg font-bold text-secondary mt-16 mb-4">
                    Nombre d'utilisateurs
                </h2>
                <div class="chartWrapper">
                    <LineChart
                        v-if="numberOfNewUsersPerMonth !== null"
                        :chartData="usersEvolutionData"
                        :chartOptions="{ maintainAspectRatio: false }"
                        :height="250"
                    />
                    <span class="text-display-lg font-bold" v-else>...</span>
                </div>
            </div>

            <div class="mt-16">
                <h2 class="text-display-lg font-bold text-secondary mb-4">
                    Nombre d'utilisateurs par semaine
                </h2>
                <div class="chartWrapper">
                    <LineChart
                        v-if="wauData !== null"
                        :chartData="wauData"
                        :chartOptions="{ maintainAspectRatio: false }"
                        :height="250"
                    />
                    <span class="text-display-lg font-bold" v-else>...</span>
                </div>
            </div>

            <StatsSection title="Usage" class="mt-16">
                <StatsBlock
                    :title="numberOfExports"
                    icon="file-download"
                    subtitle="extractions de données réalisées"
                    info="Les exports Excel permettent aux acteurs locaux d'utiliser et d'analyser les données afin de suivre, communiquer et optimiser les actions de résorption depuis le 15/11/2019."
                />
                <StatsBlock
                    :title="numberOfComments"
                    icon="comment"
                    subtitle="commentaires créés"
                    info="Au delà du suivi des chiffrés, les commentaires permettent de suivre et de partager des informations qualitative utiles dans une action multi-partenariale."
                />
                <StatsBlock
                    :title="numberOfDirectoryViews"
                    icon="address-book"
                    subtitle="fiches contact consultées"
                    info="L'annuaire permet d'accéder aux coordonnées de tous les utilisateurs de la plateforme. Son utilisation participe à la mise en réseau partenaires locaux ou des pairs depuis le 15/11/2019"
                />
            </StatsSection>

            <StatsSection title="Fréquence de mise à jour" class="mt-16">
                <template v-slot:info
                    ><span class="text-secondary">
                        <Icon icon="sync" width="16" height="16" />
                    </span>
                    La mise à jour régulière des données garantissent des
                    informations justes à tous les acteurs.</template
                >
                <template v-slot:default>
                    <StatsBlock
                        :title="medianTimeBeforeCreationDeclaration"
                        subtitle="jours entre l'installation d'un bidonville ou squat et sa déclaration"
                        info="Médiane depuis le 01/09/2019."
                    />
                    <StatsBlock
                        :title="medianTimeBeforeClosingDeclaration"
                        subtitle="jours entre la fermeture du site et sa déclaration"
                        info="Médiane depuis le 01/09/2019."
                    />
                    <StatsBlock
                        :title="numberOfShantytownOperations"
                        subtitle="mises à jour de bidonvilles et squats"
                        info="Toutes opérations confondues : création, modification, fermeture"
                    />
                </template>
            </StatsSection>
        </ContentWrapper>
    </section>
</template>

<script setup>
import { ref, computed, onMounted } from "vue";
import ENV from "@/helpers/env.js";
import { ContentWrapper } from "@resorptionbidonvilles/ui";
import StatsBlock from "./StatsBlock.vue";
import StatsSection from "./StatsSection.vue";
import { Icon } from "@resorptionbidonvilles/ui";
import { LineChart, PieChart } from "@/helpers/chart.js";

const { API_URL } = ENV;

const state = ref(null);
const stats = ref(null);

onMounted(load);

function load() {
    if (state.value === "loading") {
        return;
    }

    state.value = "loading";

    fetch(`${API_URL}/stats`)
        .then((response) => response.json())
        .then((response) => {
            stats.value = response.response.statistics;
            stats.value.state = "loaded";
        });
}

const numberOfDepartements = computed(() => {
    return stats.value ? stats.value.numberOfDepartements : "...";
});

const numberOfTerritorialCollectivitieUsers = computed(() => {
    return stats.value
        ? stats.value.numberOfCollaboratorAndAssociationUsers
              .territorial_collectivity || 0
        : "...";
});

const numberOfAssociationUsers = computed(() => {
    return stats.value
        ? stats.value.numberOfCollaboratorAndAssociationUsers.association || 0
        : "...";
});

const numberOfPublicEstablishmentUsers = computed(() => {
    return stats.value
        ? stats.value.numberOfCollaboratorAndAssociationUsers
              .public_establishment || 0
        : "...";
});

const numberOfAdministrationUsers = computed(() => {
    return stats.value
        ? stats.value.numberOfCollaboratorAndAssociationUsers.administration ||
              0
        : "...";
});

const numberOfExports = computed(() => {
    return stats.value ? stats.value.numberOfExports : "...";
});

const numberOfComments = computed(() => {
    return stats.value ? stats.value.numberOfComments : "...";
});

const numberOfDirectoryViews = computed(() => {
    return stats.value ? stats.value.numberOfDirectoryViews : "...";
});

const numberOfNewUsersPerMonth = computed(() => {
    return (stats.value && stats.value.numberOfNewUsersPerMonth) || null;
});

const usersEvolutionData = computed(() => {
    if (
        numberOfNewUsersPerMonth.value === null ||
        stats.value.numberOfUsersOnJune2020 === null
    ) {
        return [];
    }

    const initialValue = parseInt(stats.value.numberOfUsersOnJune2020, 10);

    const cumulativeData = numberOfNewUsersPerMonth.value.reduce(
        (acc, { total }, index) =>
            index === 0
                ? [parseInt(total, 10) + initialValue]
                : [...acc, parseInt(total, 10) + acc[acc.length - 1]],
        []
    );

    return {
        labels: numberOfNewUsersPerMonth.value.map(({ month }) => month),
        datasets: [
            {
                label: "Nombre d'utilisateurs inscrits",
                data: cumulativeData,
                fill: true,
            },
            {
                label: "Nombre d'utilisateurs actifs",
                data: stats.value.numberOfActiveUsersPerMonth.map(
                    ({ total }) => total
                ),
                fill: true,
                borderColor: "#BFBFE3",
                backgroundColor: "#BFBFE3",
            },
        ],
    };
});

const organizationRepartitionData = computed(() => {
    return {
        labels: [
            "services de l'État",
            "collectivités territoriales",
            "associations",
            "administration",
        ],
        datasets: [
            {
                backgroundColor: ["#169B62", "#5770BE", "#FF8D7E", "#6A6A6A"],
                data: [
                    numberOfPublicEstablishmentUsers.value,
                    numberOfTerritorialCollectivitieUsers.value,
                    numberOfAssociationUsers.value,
                    numberOfAdministrationUsers.value,
                ],
                label: "utilisateurs institutionnels et associatifs",
            },
        ],
    };
});

const numberOfNewUsers = computed(() => {
    return stats.value && stats.value.numberOfNewUsersPerMonth
        ? stats.value.numberOfNewUsersPerMonth.slice(-1)[0]
        : { total: "...", month: "..." };
});

const medianTimeBeforeCreationDeclaration = computed(() => {
    return stats.value
        ? Math.round(stats.value.meanTimeBeforeCreationDeclaration.median) ||
              "?"
        : "...";
});

const medianTimeBeforeClosingDeclaration = computed(() => {
    return stats.value
        ? Math.round(stats.value.meanTimeBeforeClosingDeclaration.median) || "?"
        : "...";
});

const numberOfShantytownOperations = computed(() => {
    return stats.value ? stats.value.numberOfShantytownOperations : "...";
});

const wauData = computed(() => {
    if (!stats.value) {
        return null;
    }

    return {
        scales: {
            y: {
                min: 0,
            },
        },
        labels: stats.value.wau.map(({ monday }) => `Semaine du ${monday}`),
        datasets: [
            {
                backgroundColor: "#E5E5F4",
                data: stats.value.wau.map(({ wau }) => wau),
                label: "Nombre d'utilisateurs sur la semaine",
            },
        ],
    };
});

function generateLabels(chart) {
    const data = chart.data;
    if (data.labels.length && data.datasets.length) {
        return data.labels.map(function (label, i) {
            // We get the value of the current label
            const value = chart.config.data.datasets[0].data[i];
            const background = chart.config.data.datasets[0].backgroundColor[i];

            return {
                text: label + " : " + value,
                index: i,
                fillStyle: background,
            };
        });
    } else {
        return [];
    }
}
</script>

<style scoped>
.chartWrapper {
    max-height: 300px;
    position: relative;
}
</style>
